rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Users collection
    match /users/{userId} {
      // Authenticated users can read user data
      allow read: if isAuthenticated();
      
      // Users can create their own document on registration (after authentication)
      // When using createUserWithEmailAndPassword, the user is authenticated, so they can create their own document
      allow create: if isAuthenticated() && request.auth.uid == userId;
      
      // Users can update their own data (except role), admins can update any
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && 
         request.resource.data.role == resource.data.role) ||
        isAdmin()
      );
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Groups collection (missions)
    match /groups/{groupId} {
      // All authenticated users can read groups (to see missions and join)
      allow read: if isAuthenticated();
      
      // Only admins can create new groups/missions
      allow create: if isAdmin() &&
        request.resource.data.keys().hasAll(['name', 'participants', 'drawCompleted']) &&
        request.resource.data.name is string &&
        request.resource.data.participants is list &&
        request.resource.data.drawCompleted is bool;
      
      // Only admins can delete groups
      allow delete: if isAdmin();
      
      // Update rules for groups
      allow update: if isAuthenticated() && (
        // Admins can update anything (including running draws)
        isAdmin() ||
        // Users can only update if:
        // 1. Draw is not completed (can't modify after draw)
        // 2. They're only modifying participants list (joining or updating wishlist)
        // Note: Application logic enforces that users can only add themselves or update their own wishlist
        (!resource.data.drawCompleted && 
         request.resource.data.drawCompleted == false &&
         request.resource.data.name == resource.data.name)
      );
    }
    
    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
